# standard yml for building a lab server

---
- hosts: centos8
  remote_user: root
  become: true
  become_user: root
  vars:
    NTP_SERVER_IP: 132.163.96.5 

  tasks:

  - name: install updates using dnf
    dnf:
      name: "*"
      state: latest

  - name: Disable selinux 
    selinux:
      state: disabled 

  - name: Disable firewalld
    service: 
      name: firewalld
      enabled: no

  - name: Install ntp if this is a physical host
    when: ansible_virtualization_role == "host"
    yum:
      name: ntp
      state: latest

  - name: create ntp conf
    when: ansible_virtualization_role == "host"
    local_action: copy content="server {{ NTP_SERVER_IP }} driftfile /var/lib/ntp/drift" dest="/tmp/testfile"

  - name: copy ntp conf to server
    when: ansible_virtualization_role == "host"
    copy:
      src: /tmp/testfile
      dest: /etc/ntp.conf
      owner: root
      group: root
      mode: 0644

  - name: Install open vm tools if this is a virtual machine
    when: ansible_virtualization_role == "guest"
    dnf:
      name: open-vm-tools
      state: latest

  - name: Install common packages
    dnf:
      name: "{{ packages }}"
    vars:
      packages:
      - bind-utils
      - cifs-utils
      - curl
      - epel-release
      - net-tools
      - nfs-utils
      - rsync
      - samba-client
      - wget


  - name: Disable IPv6 with sysctl
    sysctl: name={{ item }} value=1 state=present reload=yes
    with_items:
      - net.ipv6.conf.all.disable_ipv6
      - net.ipv6.conf.default.disable_ipv6

  - name: Disable IPv6 autoconf with sysctl
    sysctl: name={{ item }} value=0 state=present reload=yes
    with_items:
      - net.ipv6.conf.all.autoconf 
      - net.ipv6.conf.default.autoconf 


